<!doctype html>
<html lang="en">
  <script>
  const BACKEND_URL = "http://127.0.0.1:5001"; // Flask

  function getToken() {
    return localStorage.getItem("token") || sessionStorage.getItem("token");
  }

  async function ensureAuth() {
    const t = getToken();
    if (!t) {
      // no token → go to login
      location.replace("login.html?from=index.html");
      return;
    }
    // validate token with /auth/me
    try {
      const r = await fetch(`${BACKEND_URL}/auth/me`, {
        headers: { Authorization: `Bearer ${t}` },
      });
      if (!r.ok) throw new Error("invalid token");
      // OK → continue loading page
      window.__AUTH_OK__ = true;
    } catch {
      localStorage.removeItem("token");
      sessionStorage.removeItem("token");
      location.replace("login.html?from=index.html");
    }
  }
  // run immediately; rest of the page should wait for this
  document.documentElement.style.visibility = "hidden";
  ensureAuth().finally(() => {
    // only show the page if we didn't redirect
    document.documentElement.style.visibility = "";
  });
</script>

<head>
  <meta charset="utf-8" />
  <title>Clause Search</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="./search.css" />
</head>
<body>
  <!-- Header -->
  <header class="site-header">
    <div class="wrap">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <h1>Clause Search</h1>
      </div>
      <nav class="top-links">
        <span class="muted">Simple Demo</span>
      </nav>
    </div>
  </header>

  <!-- Main -->
  <main class="page">
    <!-- Toolbar -->
    <form id="searchForm" class="toolbar">
      <div class="field">
        <label for="q">Query</label>
        <input id="q" class="input" placeholder="e.g. data breach notification 72 hours PDPL" value="data breach notification 72 hours PDPL" />
      </div>

      <div class="field">
        <label for="topK">Max results</label>
        <input id="topK" class="input" type="number" min="5" max="100" step="5" value="20" />
      </div>

      <div class="field">
        <label for="method">Method</label>
        <select id="method" class="input">
          <option value="lexical">lexical</option>
          <option value="semantic">semantic</option>
          <option value="hybrid" selected>hybrid</option>
        </select>
      </div>

      <div class="field row-end">
        <button id="searchBtn" class="btn btn--primary" type="submit">Search</button>
      </div>

      <!-- Alpha -->
      <div class="field" style="grid-column: 1 / -1;">
        <label for="alpha">Alpha (hybrid only)</label>
        <div class="alpha-wrap">
          <input id="alpha" class="input" type="number" step="0.05" min="0" max="1" value="0.6" />
          <span class="muted" id="alphaHint">active</span>
        </div>
      </div>
    </form>

    <!-- Stats / messages -->
    <div class="stats">
      <span id="statText">Ready.</span>
      <span id="countPill" class="pill" style="display:none"></span>
    </div>
    <div id="err" class="error" style="display:none"></div>
    <div id="info" class="info" style="display:none">Loading…</div>

    <!-- Results -->
    <section id="results" class="results" aria-live="polite"></section>
  </main>

  <script src="./search.js"></script>
</body>
</html>
